!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("kendo-elasticsearch",[],t):"object"==typeof exports?exports["kendo-elasticsearch"]=t():e["kendo-elasticsearch"]=t()}(this,function(){return function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={exports:{},id:s,loaded:!1};return e[s].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}var n=r(1),a=s(n),i=r(2),o=s(i),u=r(3),l=s(u),f=r(6),d=s(f),c=r(4),g=s(c),p=r(5),h=s(p),y=r(7),m=s(y),v=kendo.data;v.ElasticSearchDataSource=v.DataSource.extend({init:function(e){if(!e)throw new Error("Options are required to use ElasticSearchDataSource");if(!(e.transport&&e.transport.read&&e.transport.read.url))throw new Error("transport.read.url must be set to use ElasticSearchDataSource");var t=e.transport.read;t.dataType=t.dataType||"json",t.method=t.method||"POST",t.contentType=t.contentType||"application/json";var r=e.schema&&e.schema.model;if(!r)throw new Error("transport.schema.model must be set to use ElasticSearchDataSource");if(r.esMapping)r.fields=r.fields||{},v.ElasticSearchDataSource.kendoFieldsFromESMapping(r.esMapping,r,r.fields);else{if(!r.fields)throw new Error("transport.schema.model.fields/esMapping must be set");m.fill(r.fields,r)}var s={},n={};Object.keys(r.fields).forEach(function(e){var t=r.fields[e];t.esNestedPath&&(s[t.esNestedPath]=s[t.esNestedPath]||[],s[t.esNestedPath].push(t.esName)),t.esParentType&&(n[t.esParentType]=n[t.esParentType]||[],n[t.esParentType].push(t.esName)),t.esChildType&&(n[t.esChildType]=n[t.esChildType]||[],n[t.esChildType].push(t.esName))}),e.transport.parameterMap=function(t){var i=a.prepareParams(t.sort,t.group,t.columns),u={};return t.skip&&(u.from=t.skip),t.take&&(u.size=t.take),e.aggregationsOnly&&(u.from=0,u.size=0),u.sort=a.kendo2es(i,r.fields),u.query={filtered:{filter:d.kendo2es(t.filter||[],r.fields)}},u.inner_hits=g.innerHits(s,r.esMappingKey,n,u.sort,u.query.filtered.filter),u._source=Object.keys(r.fields).filter(function(e){return!r.fields[e].esNestedPath&&!r.fields[e].esParentType&&!r.fields[e].esChildType}).map(function(e){return r.fields[e].esName}),u.aggs=l.kendo2es(t.aggregate,r.fields,s,r.esMappingKey,u.query.filtered.filter),o.kendo2es(u.aggs,t.group,r.fields,s,r.esMappingKey,u.query.filtered.filter),JSON.stringify(u)};var i=e.schema;i.parse=function(t){var s=h.fromHits(t.hits.hits,r.fields);t.aggregations&&(t.aggregations.doc_count=t.hits.total);var n=l.es2kendo(t.aggregations),a=o.es2kendo(s,t.aggregations,r.fields,e.aggregationsOnly);return{total:t.hits.total,data:s,aggregates:n,groups:a}},i.aggregates=function(e){return e.aggregates},i.groups=function(e){return e.groups},i.data=i.data||"data",i.total=i.total||"total",i.model.id=i.model.id||"_id",e.serverFiltering=!0,e.serverSorting=!0,e.serverPaging=!0,e.serverAggregates=!0,e.serverGrouping=!0,v.DataSource.fn.init.call(this,e)}}),v.ElasticSearchDataSource.kendoFieldsFromESMapping=m.fromMapping},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t,s){return e.filter(function(e){var r=t[e.field];return!!r&&(r.esNestedPath===s||r.esParentType===s||r.esChildType===s)}).map(function(e){return r({},t[e.field].esFilterName,{order:e.dir,missing:"_last",mode:"asc"===e.dir?"min":"max"})})}function n(e,t){var r=[];e&&e.constructor===Array?r=e:e&&r.push(e);var s=[];return(t||[]).forEach(function(e){var t=r.filter(function(t){return t.field===e.field});t.length?(s.push(t[0]),r.splice(r.indexOf(t[0]),1)):s.push({field:e.field,dir:e.dir||"asc"})}),s=s.concat(r)}Object.defineProperty(t,"__esModule",{value:!0});t.kendo2es=s,t.prepareParams=n},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e,t,r,s,n,i){var o=[e],u=null;t.forEach(function(e){var t=r[e.field],l=a(e,r,s,n,i),f={};t.esNestedPath&&0!==t.esNestedPath.indexOf(u)?(f[t.esNestedPath+"_nested"]=f[t.esNestedPath+"_nested"]||{nested:{path:t.esFullNestedPath},aggs:{}},f[t.esNestedPath+"_nested"].aggs[e.field+"_group"]=l.group,f[t.esNestedPath+"_nested"].aggs[e.field+"_missing"]=l.missing):(f[e.field+"_group"]=l.group,f[e.field+"_missing"]=l.missing),o.forEach(function(e){Object.keys(f).forEach(function(t){e[t]=f[t]})}),o=Object.keys(l).map(function(e){return l[e].aggregations}),u=t.esNestedPath})}function a(e,t,r,s,n){var a=t[e.field],i={},o={},u=void 0,l=[];(e.aggregates||[]).forEach(function(t){t.field===e.field&&"string"!==a.type?u=t:l.push(t)}),u?(i[u.aggregate]={field:a.esAggName},u.interval&&(i[u.aggregate].interval=u.interval)):i.terms={field:a.esAggName,size:0},o.missing={field:a.esAggName};var d=f.kendo2es(l,t,r,s,n,a.esNestedPath);return i.aggregations=d,o.aggregations=d,{group:i,missing:o}}function i(e,t){var r=Object.keys(e).filter(function(e){return"_group"===e.substr(e.length-6)}).map(function(r){var s=r.substr(0,r.length-6);return t&&(e[s+"_missing"].doc_count+=t),{group:e[r],missing:e[s+"_missing"],fieldKey:s}});return Object.keys(e).filter(function(e){return"_nested"===e.substr(e.length-7)}).forEach(function(t){var s=e.doc_count-e[t].doc_count;r=r.concat(i(e[t],s))}),r}function o(e,t,r,s){var n=[];if(t){var a=i(t);a.forEach(function(t){var a=[],i=u(t.group,t.missing,t.fieldKey);a=s?i.keys.map(function(e){return i.map[e]}):c.fillInGroups(i,e,r[t.fieldKey]);var l=!1;t.group.buckets&&t.group.buckets[0]&&Object.keys(t.group.buckets[0]).forEach(function(e){"_group"!==e.substr(e.length-6)&&"_nested"!==e.substr(e.length-7)||(l=!0)}),a.forEach(function(e){l&&(e.hasSubgroups=!0,e.items=o(e.items,e.bucket,r,s)),delete e.bucket}),n=n.concat(a)})}return n}function u(e,t,r){var s={},n=[];return e.buckets.forEach(function(e){var t=e.key_as_string||e.key;n.push(t),s[t]={field:r,value:t,hasSubgroups:!1,aggregates:f.es2kendo(e),items:[],bucket:e},s[t].aggregates[r]={count:e.doc_count}}),s[""]={field:r,value:"",hasSubgroups:!1,aggregates:f.es2kendo(t),items:[],bucket:t},s[""].aggregates[r]={count:t.doc_count},{map:s,keys:n}}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var l=r(3),f=s(l),d=r(5),c=s(d);t.kendo2es=n,t.es2kendo=o},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e,t,r,s,n,a){var i={};return(e||[]).forEach(function(e){var l=t[e.field],f=l.esNestedPath,d=i;a!==f&&!function(){var e=[];a&&0!==f.indexOf(a)?(i.group_reverse_nested=i.group_reverse_nested||{reverse_nested:{},aggregations:{}},d=i.group_reverse_nested.aggregations):a&&(f=f.substr(a.length+1,f.length)),f.split(".").forEach(function(t){e.push(t);var i=a?a+"."+e.join("."):e.join("."),u=s?s+"."+i:i,l=r[i];l&&(d[i]||(d[i+"_filter_nested"]=d[i+"_filter_nested"]||{nested:{path:u},aggregations:{}},d[i+"_filter_nested"].aggregations[i+"_filter"]=d[i+"_filter_nested"].aggregations[i+"_filter"]||{filter:o.innerHitsFilter(u,null,n),aggregations:{}}),d=d[i+"_filter_nested"].aggregations[i+"_filter"].aggregations)})}(),d[e.field+"_"+e.aggregate]={},d[e.field+"_"+e.aggregate][u[e.aggregate]]={field:l.esAggName}}),i}function a(e,t){var r=t||{};return e=e||{},Object.keys(e).forEach(function(t){e[t]&&(["count","min","max","average","sum"].forEach(function(s){var n=s.length+1;if(t.substr(t.length-n)==="_"+s){var a=t.substr(0,t.length-n);r[a]=r[a]||{},r[a][s]=e[t].value}}),"_nested"!==t.substr(t.length-7)&&"_filter"!==t.substr(t.length-7)||a(e[t],r))}),r}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var i=r(4),o=s(i),u=(t.kendo2es=n,t.es2kendo=a,{count:"cardinality",min:"min",max:"max",sum:"sum",average:"avg"})},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t,s,a,i){var o={};return Object.keys(e).forEach(function(s){var u=o,l=[];s.split(".").forEach(function(o){l.push(o);var f=l.join("."),d=t?t+"."+f:f,c=e[f];c&&(u[f]||(u[f]={path:r({},d,{_source:c,size:1e4,sort:a,query:{filtered:{filter:n(d,null,i)}}})}),f!==s&&(u[f].path[d].inner_hits=u[f].path[d].inner_hits||{},u=u[f].path[d].inner_hits))})}),Object.keys(s).forEach(function(e){var t=s[e];o[e]={type:r({},e,{_source:t,size:1e4,sort:a,query:{filtered:{filter:n(null,e,i)}}})}}),o}function n(e,t,r){r=$.extend(!0,{},r);var s=r.or||r.and;return s&&(s.filters=s.filters.filter(function(r){return r.and||r.or||r.nested&&r.nested.path===e||r.not&&r.not.nested&&r.not.nested.path===e||r.has_child&&r.has_child.type===t||r.not&&r.not.has_child&&r.not.has_child.type===t||r.has_parent&&r.has_parent.type===t||r.not&&r.not.has_parent&&r.not.has_parent.type===t}).map(function(t){return t.nested?t.nested.filter:t.not&&t.not.nested?{not:t.not.nested.filter}:t.has_child?t.has_child.filter:t.not&&t.not.has_child?{not:t.not.has_child.filter}:t.has_parent?t.has_parent.filter:t.not&&t.not.has_parent?{not:t.not.has_parent.filter}:n(e,t)})),r}Object.defineProperty(t,"__esModule",{value:!0});t.innerHits=s,t.innerHitsFilter=n},function(e,t){"use strict";function r(e,t,r){var s=[];return t.forEach(function(t){var n=e.map[t[r.key]||""];if(!n)for(var a="date"===r.type?new Date(t[r.key]):t[r.key],i=0;i<e.keys.length;i++){var o="date"===r.type?new Date(e.keys[i]):e.keys[i];if(a>=o){var u=e.keys[i+1]&&("date"===r.type?new Date(e.keys[i+1]):e.keys[i+1]);(!u||a<u)&&(n=e.map[e.keys[i]])}}if(!n)throw new Error("No group found, val: "+t[r.key]+" field: "+r.key);n.items.push(t),1===n.items.length&&s.push(n)}),s}function s(e,t){var r=[],n=e[t[0]];return void 0===n?[]:(t.length>1?$.isArray(n)?n.forEach(function(e){r=r.concat(s(e,t.slice(1)))}):r=s(n,t.slice(1)):r=$.isArray(n)?n:[n],r)}function n(e,t,r){var i=[];return e.forEach(function(e){var a=e._source||{},o={};o.id=[e._id],Object.keys(t).filter(function(e){var s=t[e];return void 0===r?!(s.esNestedPath||s.esChildType||s.esParentType):s.esNestedPath===r||s.esChildType===r||s.esParentType===r}).forEach(function(e){var r=t[e],n=s(a,r.esNameSplit);if(r.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===r.duration&&(n=n.map(function(e){return moment().startOf("day").diff(moment(e).startOf("day"),"days")})),"afterToday"===r.duration&&(n=n.map(function(e){return moment(e).startOf("day").diff(moment().startOf("day"),"days")})),n&&(r.esMultiSplit?n&&n.length?o[e]=n:o[e]=[null]:o[e]=n.join(r.esMultiSeparator||"\n"))});var u=[o];Object.keys(e.inner_hits||{}).forEach(function(r){var s=n(e.inner_hits[r].hits.hits,t,r),a=[];u.forEach(function(e){s.length?s.forEach(function(t){var r={};Object.keys(t).forEach(function(e){r[e]=t[e]}),Object.keys(e).forEach(function(t){r[t]=e[t]}),a.push(r)}):a.push(e)}),u=a}),i=i.concat(u)}),a(i)}function a(e){var t=[];return e.forEach(function(e){var r=[{}];Object.keys(e).forEach(function(t){var s=[];e[t]&&e[t].constructor===Array?e[t].forEach(function(e){r.forEach(function(r){var n={};Object.keys(r).forEach(function(e){return n[e]=r[e]}),n[t]=e,s.push(n)})}):r.forEach(function(r){r[t]=e[t],s.push(r)}),r=s}),t=t.concat(r)}),t}Object.defineProperty(t,"__esModule",{value:!0});t.fillInGroups=r,t.fromHits=n},function(e,t){"use strict";function r(e,t){var n=void 0,a="and";if(e.operator)n=[e];else if(e.logic)a=e.logic,n=e.filters||[];else{if(e.constructor!==Array)throw new Error("Unsupported filter object: "+e);n=e}var i=[],o={};n.forEach(function(e){if(e.logic)i.push(r(e,t));else{var n=t[e.field];if(!n)throw new Error("Unknown field in filter: "+e.field);var u={query:{query_string:{query:s(e,t),analyze_wildcard:!0}}};if(n.esNestedPath){var l=o[n.esNestedPath]||{nested:{path:n.esFullNestedPath,filter:{}}};l.nested.filter[a]=l.nested.filter[a]||{filters:[]},l.nested.filter[a].filters.push(u),u=o[n.esNestedPath]?null:o[n.esNestedPath]=l}else n.esParentType?u={has_parent:{type:n.esParentType,filter:u}}:n.esChildType&&(u={has_child:{type:n.esChildType,filter:u}});u&&i.push(u)}});var u={};return u[a]={filters:i},u}function s(e,t){e.operator=e.operator||"eq";var r=t[e.field];if(r.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===r.duration&&(e.value=moment().startOf("day").subtract(e.value,"days").format(),"lt"===e.operator?e.operator="gt":"lte"===e.operator?e.operator="gte":"gt"===e.operator?e.operator="lt":"gte"===e.operator&&(e.operator="lte")),"afterToday"===r.duration&&(e.value=moment().startOf("day").add(e.value,"days").format());var s=void 0;s="search"===e.operator?r.esSearchName:r.esFilterName;var a=n(s),i=n(e.value,e.operator),o={eq:"",search:"",lt:"<",lte:"<=",gt:">",gte:">="};if(void 0!==o[e.operator]){var u=o[e.operator];return a+":"+u+i}var l=void 0;switch(e.operator){case"neq":return"NOT ("+a+":"+i+")";case"contains":return"("+a+":*"+i+"*)";case"doesnotcontain":return"NOT ("+a+":*"+i+"*)";case"startswith":return a+":"+i+"*";case"endswith":return a+":*"+i;case"missing":if(r.esNestedPath||r.esParentType||r.esChildType)throw new Error("missing filter is not supported on nested fields");return l="_missing_:"+a,"string"===r.type&&(l+=" OR ("+a+':"")'),l;case"exists":return l="_exists_:"+a,"string"===r.type&&(l+=" AND NOT("+a+':"")'),l;default:throw new Error("Unsupported Kendo filter operator: "+e.operator)}}function n(e,t){return e.constructor===Date?e=e.toISOString():"boolean"!=typeof e&&"number"!=typeof e||(e=""+e),"search"===t?(e=e.replace("\\","\\\\"),(e.match(/"/g)||[]).length%2===1&&(e=e.replace(/"/g,'\\"')),e=e.replace(i,"\\$&")):e.replace("\\","\\\\").replace(a,"\\$&")}Object.defineProperty(t,"__esModule",{value:!0});var a=(t.kendo2es=r,/[+\-&|!()\{}\[\]^:"~*?:\/ ]/g),i=/[+\-&|!()\{}\[\]^:~:\/]/g},function(e,t){"use strict";function r(e,t,a,i,o,u){return a=a||{},i=i||"",Object.keys(e.properties||{}).forEach(function(s){var l=e.properties[s],f=n(s),d=i?i+"_"+f:f,c=o?o+"."+s:s;if("nested"===l.type){var g=u?u+"."+c:c;r(l,t,a,d,"",g)}else if(l.properties)r(l,t,a,d,c,u);else if("object"===l.type);else{var p=a[d]=a[d]||{};p.esNestedPath||(p.type=p.type||l.type,["float","double","integer","long","short","byte"].indexOf(p.type)!==-1&&(p.type="number"),"string"!==p.type&&(p.esMultiSplit=!0),u&&(p.esNestedPath=u),p.esName=c,"not_analyzed"===l.index&&(p.esSearchSubField=null,p.esFilterSubField=null,p.esAggSubField=null))}}),s(a,t),a}function s(e,t){for(var r in e)if(e.hasOwnProperty(r)){var s=e[r];s.key=r,s.esName=s.esName||r,s.esNameSplit=s.esName.split("."),s.esFullNestedPath=s.esNestedPath,t.esMappingKey&&(s.esFullNestedPath=t.esMappingKey+"."+s.esFullNestedPath),s.esSearchName||(s.esSearchName=s.esName,s.hasOwnProperty("esSearchSubField")?s.esSearchSubField&&(s.esSearchName+="."+s.esSearchSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.search&&(s.esSearchName+="."+t.esStringSubFields.search),s.esNestedPath&&(s.esSearchName=s.esNestedPath+"."+s.esSearchName)),s.esFilterName||(s.esFilterName=s.esName,s.hasOwnProperty("esFilterSubField")?s.esFilterSubField&&(s.esFilterName+="."+s.esFilterSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.filter&&(s.esFilterName+="."+t.esStringSubFields.filter),s.esNestedPath&&(s.esFilterName=s.esNestedPath+"."+s.esFilterName)),s.esAggName||(s.esAggName=s.esName,s.hasOwnProperty("esAggSubField")?s.esAggSubField&&(s.esAggName+="."+s.esAggSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.agg&&(s.esAggName+="."+t.esStringSubFields.agg),s.esNestedPath&&(s.esAggName=s.esFullNestedPath+"."+s.esAggName))}}function n(e){return e.replace(/[^a-zA-z0-9_$]/g,"_")}Object.defineProperty(t,"__esModule",{value:!0});t.fromMapping=r,t.fill=s}])});
//# sourceMappingURL=kendo-elasticsearch.min.js.map